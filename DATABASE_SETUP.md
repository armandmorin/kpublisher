# Database Setup Instructions

This document provides instructions for setting up the database for the KPublisher application.

## Prerequisites

- Access to your Supabase project dashboard
- Basic knowledge of SQL

## Step 1: Run the SQL Script

1. Go to your Supabase project dashboard: https://app.supabase.com/project/tvzpyrzrmcbkibanfbdb
2. Navigate to "SQL Editor"
3. Create a new query
4. Open the file `setup-database.sql` from this project
5. Copy the entire contents of the file
6. Paste it into the SQL Editor
7. Click "Run" to execute the SQL script

This script will:
- Create all necessary tables (users, books, book_covers, api_keys, assistants, subscription_plans)
- Set up Row Level Security (RLS) policies
- Create triggers and functions
- Insert initial data for API keys, assistants, and subscription plans

## Step 2: Create an Admin User

### Option 1: Using the HTML Tool (Recommended)

1. Open the file `create-admin-user.html` in a web browser
2. The default email and password are:
   - Email: armandmorin@gmail.com
   - Password: 1armand
3. You can change these if desired
4. Click "Create Admin User"
5. Wait for the process to complete
6. You should see a success message if everything worked correctly

### Option 2: Using the Supabase Dashboard

1. Go to your Supabase project dashboard
2. Navigate to "Authentication" > "Users"
3. Click "Add User"
4. Enter:
   - Email: armandmorin@gmail.com
   - Password: 1armand
5. Click "Create User"
6. After creating the user, run the following SQL in the SQL Editor:

```sql
UPDATE public.users
SET role = 'admin'
WHERE email = 'armandmorin@gmail.com';
```

## Step 3: Verify Setup

1. Go to your deployed application: https://kpublisher.netlify.app/auth/login
2. Log in with the admin credentials:
   - Email: armandmorin@gmail.com
   - Password: 1armand
3. You should be redirected to the dashboard
4. Navigate to the admin sections to verify you have admin access

## Troubleshooting

### Error: "relation 'users' does not exist"

This means the database tables haven't been created yet. Make sure you've run the SQL script in Step 1.

### Error: "Invalid credentials"

This could be due to:
1. The user doesn't exist in the auth system
2. The password is incorrect
3. Email confirmation is required (check Authentication > Providers > Email settings)

### Error: "500 Internal Server Error" when accessing users table

This could be due to:
1. The users table doesn't exist
2. The RLS policies are not set up correctly
3. The user doesn't have permission to access the table

Try running the SQL script again to ensure all tables and policies are created correctly.

### Error: "Cannot access 'supabase' before initialization"

If you're using the HTML tool and see this error, try refreshing the page. The Supabase client might not have loaded correctly.

## Database Schema

The database consists of the following tables:

1. **users** - Stores user information and links to auth.users
2. **books** - Stores book content created by users
3. **book_covers** - Stores book cover images generated by users
4. **api_keys** - Stores API keys for external services
5. **assistants** - Stores OpenAI assistant configurations
6. **subscription_plans** - Stores subscription plan details

Each table has appropriate RLS policies to ensure data security.
